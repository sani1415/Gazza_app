{% extends "base.html" %}

{% block title %}{{ t('tools_dashboard') }} - {{ t('app_name') }}{% endblock %}

{% block content %}
<section class="py-4 bg-secondary text-white">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <h1 class="mb-2">
                    <i class="fas fa-tools me-2"></i>
                    {{ t('tools_dashboard') }}
                </h1>
                <p class="mb-0">{{ t('tools_description') }}</p>
            </div>
        </div>
    </div>
</section>

<section class="py-5">
    <div class="container">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h3 class="card-title mb-4">
                            <i class="fas fa-file-word me-2 text-primary"></i>
                            {{ t('create_word_files') }}
                        </h3>
                        <form id="exportForm" class="row g-3">
                            <div class="col-12">
                                <label for="exportDate" class="form-label">{{ t('date') }}</label>
                                <input type="date" class="form-control" id="exportDate" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">{{ t('file_type') }}</label>
                                <div class="list-group">
                                    <button type="button" class="list-group-item list-group-item-action" id="exportHeadlinesBtn">
                                        <i class="fas fa-align-left me-2"></i>
                                        {{ t('word_with_summaries') }}
                                    </button>
                                    <button type="button" class="list-group-item list-group-item-action" id="exportHeadlineOnlyBtn">
                                        <i class="fas fa-align-justify me-2"></i>
                                        {{ t('word_headlines_full') }}
                                    </button>
                                    <button type="button" class="list-group-item list-group-item-action" id="exportWithImagesBtn">
                                        <i class="fas fa-image me-2"></i>
                                        {{ t('word_with_images') }}
                                    </button>
                                </div>
                            </div>
                            <div class="col-12">
                                <div id="exportStatus" class="alert alert-info" style="display:none;"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Progress Modal -->
            <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="progressModalLabel">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                {{ t('creating_file') }}
                            </h5>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span id="progressPercentage" class="fw-bold">0%</span>
                                    <span id="progressStatus" class="text-muted">{{ t('starting_process') }}</span>
                                </div>
                                <div class="progress" style="height: 30px;">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        0%
                                    </div>
                                </div>
                            </div>
                            <div id="progressMessage" class="text-center text-muted small">
                                {{ t('preparing') }}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancelProgressBtn" style="display:none;">{{ t('cancel') }}</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h3 class="card-title mb-4">
                            <i class="fas fa-download me-2 text-success"></i>
                            {{ t('download_images') }}
                        </h3>
                        <form id="imageDownloadForm" class="row g-3">
                            <div class="col-md-6">
                                <label for="imageDate" class="form-label">{{ t('date_optional') }}</label>
                                <input type="date" class="form-control" id="imageDate">
                                <div class="form-text">{{ t('leave_empty_all') }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="imageLimit" class="form-label">{{ t('max_images') }}</label>
                                <input type="number" class="form-control" id="imageLimit" min="1" step="1">
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="forceDownload">
                                    <label class="form-check-label" for="forceDownload">
                                        {{ t('force_reload') }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-cloud-download-alt me-2"></i>
                                    {{ t('start_download') }}
                                </button>
                            </div>
                            <div class="col-12">
                                <div id="downloadStatus" class="alert" style="display:none;"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Translations for JavaScript
const translations = {
    'ar': {
        'please_select_date_first': 'يرجى تحديد التاريخ أولاً.',
        'preparing': 'جاري التجهيز...',
        'starting_process': 'بدء العملية...',
        'completed': 'اكتمل!',
        'file_created_success': 'تم إنشاء الملف بنجاح! جاري التنزيل...',
        'error_occurred_file': 'حدث خطأ أثناء إنشاء الملف',
        'close': 'إغلاق',
        'connection_error': 'حدث خطأ في الاتصال بالخادم',
        'downloading_images': 'جاري تنزيل الصور ... يرجى الانتظار.',
        'error_downloading_images': 'حدث خطأ أثناء تنزيل الصور.',
        'export_success_headlines': 'تم إنشاء الملف مع العناوين والملخصات بنجاح، جاري التنزيل...',
        'export_success': 'تم إنشاء الملف بنجاح، جاري التنزيل...',
        'export_success_images': 'تم إنشاء الملف مع الصور بنجاح، جاري التنزيل...',
        'requested_images': 'تم طلب',
        'image_with_links': 'صورة تحتوي على روابط.',
        'downloaded_new': 'تم تنزيل',
        'new_image': 'صورة جديدة.',
        'skipped_existing': 'تم تخطي',
        'existing_images': 'صور موجودة مسبقًا.',
        'errors_during': 'أخطاء أثناء التحميل:',
        'folder': 'المجلد:'
    },
    'en': {
        'please_select_date_first': 'Please select a date first.',
        'preparing': 'Preparing...',
        'starting_process': 'Starting process...',
        'completed': 'Completed!',
        'file_created_success': 'File created successfully! Downloading...',
        'error_occurred_file': 'An error occurred while creating the file',
        'close': 'Close',
        'connection_error': 'A connection error occurred with the server',
        'downloading_images': 'Downloading images... Please wait.',
        'error_downloading_images': 'An error occurred while downloading images.',
        'export_success_headlines': 'File with headlines and summaries created successfully, downloading...',
        'export_success': 'File created successfully, downloading...',
        'export_success_images': 'File with images created successfully, downloading...',
        'requested_images': 'Requested',
        'image_with_links': 'images with links.',
        'downloaded_new': 'Downloaded',
        'new_image': 'new images.',
        'skipped_existing': 'Skipped',
        'existing_images': 'existing images.',
        'errors_during': 'Errors during download:',
        'folder': 'Folder:'
    }
};

const currentLang = '{{ lang }}';
const t = (key) => translations[currentLang]?.[key] || key;

const exportStatus = document.getElementById('exportStatus');
const exportDateInput = document.getElementById('exportDate');
const exportHeadlinesBtn = document.getElementById('exportHeadlinesBtn');
const exportHeadlineOnlyBtn = document.getElementById('exportHeadlineOnlyBtn');
const exportWithImagesBtn = document.getElementById('exportWithImagesBtn');

const downloadStatus = document.getElementById('downloadStatus');
const imageDownloadForm = document.getElementById('imageDownloadForm');
const imageDateInput = document.getElementById('imageDate');
const imageLimitInput = document.getElementById('imageLimit');
const forceDownloadCheck = document.getElementById('forceDownload');

const showExportMessage = (message, type = 'info') => {
    exportStatus.className = `alert alert-${type}`;
    exportStatus.textContent = message;
    exportStatus.style.display = 'block';
};

const showDownloadMessage = (message, type = 'info') => {
    downloadStatus.className = `alert alert-${type}`;
    downloadStatus.textContent = message;
    downloadStatus.style.display = 'block';
};

const triggerDownload = (url) => {
    const link = document.createElement('a');
    link.href = url;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

// Reusable function for progress tracking
function startExportWithProgress(startEndpoint, progressEndpoint, successMessage, includeContent = false) {
    const date = exportDateInput.value;
    if (!date) {
        showExportMessage(t('please_select_date_first'), 'warning');
        return;
    }

    // Show progress modal
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    const progressBar = document.getElementById('progressBar');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressMessage = document.getElementById('progressMessage');
    const progressStatus = document.getElementById('progressStatus');
    const cancelBtn = document.getElementById('cancelProgressBtn');
    
    let eventSource = null;
    let jobId = null;

    // Reset progress
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    progressBar.setAttribute('aria-valuenow', '0');
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
    progressPercentage.textContent = '0%';
    progressMessage.textContent = t('preparing');
    progressStatus.textContent = t('starting_process');
    cancelBtn.style.display = 'none';

    // Start the job
    fetch(startEndpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            date: date,
            include_content: includeContent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        jobId = data.job_id;
        
        // Show modal
        progressModal.show();
        
        // Connect to SSE
        eventSource = new EventSource(`${progressEndpoint}/${jobId}`);
        
        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const percentage = data.percentage || 0;
            const message = data.message || '';
            const status = data.status || 'processing';
            
            // Update progress bar
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', percentage);
            progressPercentage.textContent = `${percentage}%`;
            progressMessage.textContent = message;
            progressStatus.textContent = `${percentage}%`;
            
            if (status === 'completed') {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
                progressStatus.textContent = t('completed');
                progressMessage.textContent = t('file_created_success');
                
                // Close modal and trigger download
                setTimeout(() => {
                    progressModal.hide();
                    eventSource.close();
                    
                    if (data.download_url) {
                        triggerDownload(data.download_url);
                        showExportMessage(successMessage, 'success');
                    }
                }, 1000);
            } else if (status === 'error') {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
                progressStatus.textContent = 'خطأ!';
                progressMessage.textContent = data.error || t('error_occurred_file');
                cancelBtn.style.display = 'block';
                cancelBtn.textContent = t('close');
                cancelBtn.onclick = () => {
                    progressModal.hide();
                    eventSource.close();
                };
                showExportMessage(data.error || t('error_occurred_file'), 'danger');
            }
        };
        
        eventSource.onerror = (error) => {
            console.error('SSE error:', error);
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
            progressStatus.textContent = 'خطأ في الاتصال!';
            progressMessage.textContent = t('connection_error');
            cancelBtn.style.display = 'block';
            cancelBtn.textContent = t('close');
            cancelBtn.onclick = () => {
                progressModal.hide();
                if (eventSource) eventSource.close();
            };
            showExportMessage(t('connection_error'), 'danger');
        };
    })
    .catch(error => {
        showExportMessage(error.message, 'danger');
        if (eventSource) eventSource.close();
    });
}

exportHeadlinesBtn.addEventListener('click', () => {
    startExportWithProgress(
        '/api/export/word/start',
        '/api/export/word/progress',
        t('export_success_headlines')
    );
});

exportHeadlineOnlyBtn.addEventListener('click', () => {
    startExportWithProgress(
        '/api/export/headline-only/start',
        '/api/export/headline-only/progress',
        t('export_success')
    );
});

exportWithImagesBtn.addEventListener('click', () => {
    startExportWithProgress(
        '/api/export/word-with-images/start',
        '/api/export/word-with-images/progress',
        t('export_success_images'),
        true  // include_content = true
    );
});

imageDownloadForm.addEventListener('submit', (event) => {
    event.preventDefault();
    showDownloadMessage(t('downloading_images'), 'info');

    const payload = {
        date: imageDateInput.value || null,
        limit: imageLimitInput.value ? Number(imageLimitInput.value) : null,
        force: forceDownloadCheck.checked
    };

    fetch('/api/tools/download-images', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || t('error_downloading_images'));
        }
        const parts = currentLang === 'ar' ? [
            `${t('requested_images')} ${data.requested} ${t('image_with_links')}`,
            `${t('downloaded_new')} ${data.downloaded} ${t('new_image')}`,
            `${t('skipped_existing')} ${data.skipped} ${t('existing_images')}`,
            `${t('errors_during')} ${data.errors}.`,
            `${t('folder')} ${data.output_dir}`
        ] : [
            `${t('requested_images')} ${data.requested} ${t('image_with_links')}`,
            `${t('downloaded_new')} ${data.downloaded} ${t('new_image')}`,
            `${t('skipped_existing')} ${data.skipped} ${t('existing_images')}`,
            `${t('errors_during')} ${data.errors}.`,
            `${t('folder')} ${data.output_dir}`
        ];
        showDownloadMessage(parts.join('\n'), 'success');
    })
    .catch(error => {
        showDownloadMessage(error.message, 'danger');
    });
});
</script>
{% endblock %}
