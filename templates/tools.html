{% extends "base.html" %}

{% block title %}أدوات الإدارة - أرشيف أخبار فلسطين{% endblock %}

{% block content %}
<section class="py-4 bg-secondary text-white">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <h1 class="mb-2">
                    <i class="fas fa-tools me-2"></i>
                    لوحة الأدوات
                </h1>
                <p class="mb-0">إدارة التنزيلات، إنشاء الملفات، والعمل مع الصور بسهولة</p>
            </div>
        </div>
    </div>
</section>

<section class="py-5">
    <div class="container">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h3 class="card-title mb-4">
                            <i class="fas fa-file-word me-2 text-primary"></i>
                            إنشاء ملفات Word
                        </h3>
                        <form id="exportForm" class="row g-3">
                            <div class="col-12">
                                <label for="exportDate" class="form-label">التاريخ</label>
                                <input type="date" class="form-control" id="exportDate" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">نوع الملف</label>
                                <div class="list-group">
                                    <button type="button" class="list-group-item list-group-item-action" id="exportHeadlinesBtn">
                                        <i class="fas fa-align-left me-2"></i>
                                        ملف Word مع العناوين والملخصات (كما في صفحة العناوين)
                                    </button>
                                    <button type="button" class="list-group-item list-group-item-action" id="exportHeadlineOnlyBtn">
                                        <i class="fas fa-align-justify me-2"></i>
                                        ملف Word يحتوي على العناوين متبوعة بالمحتوى الكامل (بدون ملخص)
                                    </button>
                                    <button type="button" class="list-group-item list-group-item-action" id="exportWithImagesBtn">
                                        <i class="fas fa-image me-2"></i>
                                        ملف Word يشمل الصور مع المحتوى الكامل لكل مقال
                                    </button>
                                </div>
                            </div>
                            <div class="col-12">
                                <div id="exportStatus" class="alert alert-info" style="display:none;"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Progress Modal -->
            <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="progressModalLabel">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                جاري إنشاء الملف...
                            </h5>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span id="progressPercentage" class="fw-bold">0%</span>
                                    <span id="progressStatus" class="text-muted">بدء العملية...</span>
                                </div>
                                <div class="progress" style="height: 30px;">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        0%
                                    </div>
                                </div>
                            </div>
                            <div id="progressMessage" class="text-center text-muted small">
                                جاري التجهيز...
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancelProgressBtn" style="display:none;">إلغاء</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h3 class="card-title mb-4">
                            <i class="fas fa-download me-2 text-success"></i>
                            تنزيل الصور
                        </h3>
                        <form id="imageDownloadForm" class="row g-3">
                            <div class="col-md-6">
                                <label for="imageDate" class="form-label">التاريخ (اختياري)</label>
                                <input type="date" class="form-control" id="imageDate">
                                <div class="form-text">اتركه فارغاً لتحميل جميع الصور</div>
                            </div>
                            <div class="col-md-6">
                                <label for="imageLimit" class="form-label">حد أقصى للصور (اختياري)</label>
                                <input type="number" class="form-control" id="imageLimit" min="1" step="1">
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="forceDownload">
                                    <label class="form-check-label" for="forceDownload">
                                        إعادة تحميل الصور حتى لو كانت موجودة (Force)
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-cloud-download-alt me-2"></i>
                                    بدء تنزيل الصور
                                </button>
                            </div>
                            <div class="col-12">
                                <div id="downloadStatus" class="alert" style="display:none;"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
const exportStatus = document.getElementById('exportStatus');
const exportDateInput = document.getElementById('exportDate');
const exportHeadlinesBtn = document.getElementById('exportHeadlinesBtn');
const exportHeadlineOnlyBtn = document.getElementById('exportHeadlineOnlyBtn');
const exportWithImagesBtn = document.getElementById('exportWithImagesBtn');

const downloadStatus = document.getElementById('downloadStatus');
const imageDownloadForm = document.getElementById('imageDownloadForm');
const imageDateInput = document.getElementById('imageDate');
const imageLimitInput = document.getElementById('imageLimit');
const forceDownloadCheck = document.getElementById('forceDownload');

const showExportMessage = (message, type = 'info') => {
    exportStatus.className = `alert alert-${type}`;
    exportStatus.textContent = message;
    exportStatus.style.display = 'block';
};

const showDownloadMessage = (message, type = 'info') => {
    downloadStatus.className = `alert alert-${type}`;
    downloadStatus.textContent = message;
    downloadStatus.style.display = 'block';
};

const triggerDownload = (url) => {
    const link = document.createElement('a');
    link.href = url;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

// Reusable function for progress tracking
function startExportWithProgress(startEndpoint, progressEndpoint, successMessage, includeContent = false) {
    const date = exportDateInput.value;
    if (!date) {
        showExportMessage('يرجى تحديد التاريخ أولاً.', 'warning');
        return;
    }

    // Show progress modal
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    const progressBar = document.getElementById('progressBar');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressMessage = document.getElementById('progressMessage');
    const progressStatus = document.getElementById('progressStatus');
    const cancelBtn = document.getElementById('cancelProgressBtn');
    
    let eventSource = null;
    let jobId = null;

    // Reset progress
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    progressBar.setAttribute('aria-valuenow', '0');
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
    progressPercentage.textContent = '0%';
    progressMessage.textContent = 'جاري التجهيز...';
    progressStatus.textContent = 'بدء العملية...';
    cancelBtn.style.display = 'none';

    // Start the job
    fetch(startEndpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            date: date,
            include_content: includeContent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        jobId = data.job_id;
        
        // Show modal
        progressModal.show();
        
        // Connect to SSE
        eventSource = new EventSource(`${progressEndpoint}/${jobId}`);
        
        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const percentage = data.percentage || 0;
            const message = data.message || '';
            const status = data.status || 'processing';
            
            // Update progress bar
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', percentage);
            progressPercentage.textContent = `${percentage}%`;
            progressMessage.textContent = message;
            progressStatus.textContent = `${percentage}%`;
            
            if (status === 'completed') {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
                progressStatus.textContent = 'اكتمل!';
                progressMessage.textContent = 'تم إنشاء الملف بنجاح! جاري التنزيل...';
                
                // Close modal and trigger download
                setTimeout(() => {
                    progressModal.hide();
                    eventSource.close();
                    
                    if (data.download_url) {
                        triggerDownload(data.download_url);
                        showExportMessage(successMessage, 'success');
                    }
                }, 1000);
            } else if (status === 'error') {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
                progressStatus.textContent = 'خطأ!';
                progressMessage.textContent = data.error || 'حدث خطأ أثناء إنشاء الملف';
                cancelBtn.style.display = 'block';
                cancelBtn.textContent = 'إغلاق';
                cancelBtn.onclick = () => {
                    progressModal.hide();
                    eventSource.close();
                };
                showExportMessage(data.error || 'حدث خطأ أثناء إنشاء الملف', 'danger');
            }
        };
        
        eventSource.onerror = (error) => {
            console.error('SSE error:', error);
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
            progressStatus.textContent = 'خطأ في الاتصال!';
            progressMessage.textContent = 'حدث خطأ في الاتصال بالخادم';
            cancelBtn.style.display = 'block';
            cancelBtn.textContent = 'إغلاق';
            cancelBtn.onclick = () => {
                progressModal.hide();
                if (eventSource) eventSource.close();
            };
            showExportMessage('حدث خطأ في الاتصال بالخادم', 'danger');
        };
    })
    .catch(error => {
        showExportMessage(error.message, 'danger');
        if (eventSource) eventSource.close();
    });
}

exportHeadlinesBtn.addEventListener('click', () => {
    startExportWithProgress(
        '/api/export/word/start',
        '/api/export/word/progress',
        'تم إنشاء الملف مع العناوين والملخصات بنجاح، جاري التنزيل...'
    );
});

exportHeadlineOnlyBtn.addEventListener('click', () => {
    startExportWithProgress(
        '/api/export/headline-only/start',
        '/api/export/headline-only/progress',
        'تم إنشاء الملف بنجاح، جاري التنزيل...'
    );
});

exportWithImagesBtn.addEventListener('click', () => {
    startExportWithProgress(
        '/api/export/word-with-images/start',
        '/api/export/word-with-images/progress',
        'تم إنشاء الملف مع الصور بنجاح، جاري التنزيل...',
        true  // include_content = true
    );
});

imageDownloadForm.addEventListener('submit', (event) => {
    event.preventDefault();
    showDownloadMessage('جاري تنزيل الصور ... يرجى الانتظار.', 'info');

    const payload = {
        date: imageDateInput.value || null,
        limit: imageLimitInput.value ? Number(imageLimitInput.value) : null,
        force: forceDownloadCheck.checked
    };

    fetch('/api/tools/download-images', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || 'حدث خطأ أثناء تنزيل الصور.');
        }
        const parts = [
            `تم طلب ${data.requested} صورة تحتوي على روابط.`,
            `تم تنزيل ${data.downloaded} صورة جديدة.`,
            `تم تخطي ${data.skipped} صور موجودة مسبقًا.`,
            `أخطاء أثناء التحميل: ${data.errors}.`,
            `المجلد: ${data.output_dir}`
        ];
        showDownloadMessage(parts.join('\n'), 'success');
    })
    .catch(error => {
        showDownloadMessage(error.message, 'danger');
    });
});
</script>
{% endblock %}
